name: Send Webmentions for Published Posts

on:
  push:
    branches: [main]
    paths:
      - 'src/notes/**.md'
      - 'src/writing/**.md'
      - 'src/projects/**.md'

jobs:
  send-webmentions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to avoid shallow clone issues

      - name: Send Webmentions
        run: |
          DOMAIN="https://wingpang.com"

          if git rev-parse ${{ github.event.before }} >/dev/null 2>&1; then
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^src/(notes|writing|projects)/.*\.md$')
          else
            echo "No valid previous commit, listing all posts"
            FILES=$(git ls-files 'src/notes/*.md' 'src/writing/*.md' 'src/projects/*.md')
          fi

          if [ -z "$FILES" ]; then
            echo "‚úÖ No relevant content changes."
            exit 0
          fi

          for FILE in $FILES; do
            echo "üìÑ Checking $FILE"

            if grep -q '^draft:\s*true' "$FILE"; then
              echo "‚è≠Ô∏è Skipping: Not published"
              continue
            fi

            RELATIVE=${FILE#src/}
            SECTION=$(echo "$RELATIVE" | cut -d/ -f1)
            SLUG=$(basename "$RELATIVE" .md)
            POST_URL="$DOMAIN/$SECTION/$SLUG"

            TARGET=$(grep -E '^(in-reply-to|like-of|bookmark-of):' "$FILE" | head -n1 | sed 's/.*:[[:space:]]*//')

            if [ -z "$TARGET" ]; then
              TARGET="https://fed.brid.gy/"
            fi

            echo "üîó Sending Webmention: $POST_URL ‚Üí $TARGET"

            curl -s -X POST https://fed.brid.gy/webmention \
              -d "source=$POST_URL" \
              -d "target=$TARGET" \
              && echo "‚úÖ Sent to Bridgy Fed or target" \
              || {
                echo "‚ö†Ô∏è Bridgy Fed failed, trying webmention.io..."
                curl -s -X POST https://webmention.io/wingpang.com/webmention \
                  -d "source=$POST_URL" \
                  -d "target=$TARGET" \
                  && echo "‚úÖ Fallback to webmention.io succeeded" \
                  || echo "‚ùå Failed to send Webmention for $POST_URL"
              }

            echo ""
          done
