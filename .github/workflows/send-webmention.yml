name: Send Webmentions for Published Posts

on:
  push:
    branches: [main]
    paths:
      - 'src/notes/**.md'
      - 'src/writing/**.md'
      - 'src/projects/**.md'

jobs:
  send-webmentions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to compare against previous commits

      - name: Send Webmentions
        run: |
          DOMAIN="https://wingpang.com"

          if git rev-parse ${{ github.event.before }} >/dev/null 2>&1; then
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^src/(notes|writing|projects)/.*\.md$')
          else
            echo "‚ö†Ô∏è No valid previous commit found, listing all content files"
            FILES=$(git ls-files 'src/notes/*.md' 'src/writing/*.md' 'src/projects/*.md')
          fi

          if [ -z "$FILES" ]; then
            echo "‚úÖ No relevant content changes."
            exit 0
          fi

          for FILE in $FILES; do
            echo "üìÑ Checking $FILE"

            if grep -q '^draft:\s*true' "$FILE"; then
              echo "‚è≠Ô∏è Skipping draft post"
              continue
            fi

            RELATIVE=${FILE#src/}
            SECTION=$(echo "$RELATIVE" | cut -d/ -f1)
            SLUG=$(basename "$RELATIVE" .md)
            POST_URL="$DOMAIN/$SECTION/$SLUG"

            # Extract any specific webmention target
            SPECIFIC_TARGET=$(grep -E '^(in-reply-to|like-of|bookmark-of):' "$FILE" | head -n1 | sed 's/.*:[[:space:]]*//')

            # --- 1. Always send to Bridgy Fed ---
            echo "üîó Sending Webmention to Bridgy Fed: $POST_URL ‚Üí https://fed.brid.gy/"
            curl -s -X POST https://fed.brid.gy/webmention \
              -d "source=$POST_URL" \
              -d "target=https://fed.brid.gy/" \
              && echo "‚úÖ Sent to Bridgy Fed" \
              || {
                echo "‚ö†Ô∏è Bridgy Fed failed, trying webmention.io..."
                curl -s -X POST https://webmention.io/wingpang.com/webmention \
                  -d "source=$POST_URL" \
                  -d "target=https://fed.brid.gy/" \
                  && echo "‚úÖ Fallback to webmention.io succeeded" \
                  || echo "‚ùå Failed to send Webmention to Bridgy Fed"
              }

            # --- 2. Also send to specific reply/like/bookmark target ---
            if [ -n "$SPECIFIC_TARGET" ]; then
              echo "üîó Sending Webmention to target: $POST_URL ‚Üí $SPECIFIC_TARGET"
              curl -s -X POST https://webmention.io/wingpang.com/webmention \
                -d "source=$POST_URL" \
                -d "target=$SPECIFIC_TARGET" \
                && echo "‚úÖ Sent to target" \
                || echo "‚ùå Failed to send Webmention to $SPECIFIC_TARGET"
            fi

            echo ""
          done
